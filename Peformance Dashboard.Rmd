---
title: "Wifi Locationing"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}

# rsconnect::setAccountInfo(name='piedpipper23',
# 			  token='DFDEF409C35E8F1DDB11A0FB24F312BF',
# 			  secret='<SECRET>')


setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

source("1 - Inicialization and Libraries.R")

# Test <- read.csv2(file = "./csv/Daily.csv"
#           )


source("2 - Reading CSV Validation - Wifi1.R")

  
Wifi1$KeySample <-  1:nrow(Wifi1) 
TempWifiMelted1 <- Wifi1  %>% melt( id.vars = c("KeySample")
)  %>% 
  mutate( value = value + 105) %>% 
  mutate( value = case_when(value == 205 ~ 0,
                            TRUE ~ value) 
  )     
 

colnames(TempWifiMelted1)[2] <- "WAP"
colnames(TempWifiMelted1)[3] <- "SignalPow"
        
ValidationSet <- TempWifiMelted1 %>% # unique()
  tidyr::spread(WAP, SignalPow, convert = FALSE) 

ValidationSet$FLOOR <- "F0"
 levels(ValidationSet$FLOOR) <- c("F0", "F1","F2","F3","F4")
XGBoostBuildFitt <- readRDS("./models/BuildXGBoost3.rds")

ValidProbs <- predict(XGBoostBuildFitt, newdata = ValidationSet, type = "prob")

Models2 <-  c("svmRadial"
                ,"kknn"
                ,"gbm"
          )

ValidationSet$BUILDINGID <-  predict(XGBoostBuildFitt, newdata = ValidationSet)
#library(esquisse)
#esquisse::esquisser()


```

Long Lat Prediction
=======================================================================


Column {.sidebar data-width=150}
-----------------------------------------------------------------------

```{r}

  
#selectInput("Submet", label = "Submet:",
#            choices = c("AC" ,"Rest","Laundry","Kitchen"), selected = "AC")

selectInput("Building", label = "Building :",
            choices = c("B0","B1","B2"), selected = "B0")

selectInput("Floor", label = "Floor :",
            choices = c("F0","F2","F3","F4"), selected = "F0")


# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

# sliderInput("bw_adjust", label = "Bandwidth adjustment:",
#             min = 0.2, max = 2, value = 1, step = 0.2)
```

Column {data-width=450}
-----------------------------------------------------------------------


### Latitude Predictions (pending to do )

```{r include=TRUE, results='asis'}



  
prueba <- ggplot(data = ValidProbs) +
  aes(x = B0) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)


ggplotly(prueba)

     #}
```


Column {data-width=450}
-----------------------------------------------------------------------

###  Longitude RSQUARED

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  
  
   ModelsLAT2.list = as.list(vector(length = length(Models2)))
   
   for (pepe in 1:length(Models2))
   {
    # pepe <- 1
  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 ModelsLAT2.list[[pepe]] <-  readRDS( 
  paste ("./models/Long_" , Models2[pepe] , "_" ,input$Floor
         , "_" , input$Building
         , ".rds"
         , sep = "")
    )

   }
   
  models <- resamples(ModelsLAT2.list
)

 bwplot(models, metric="Rsquared")


  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```



###  Longitude RMSE

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  
  
   ModelsLAT2.list = as.list(vector(length = length(Models2)))
   
   for (pepe in 1:length(Models2))
   {
    # pepe <- 1
  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 ModelsLAT2.list[[pepe]] <-  readRDS( 
  paste ("./models/Long_" , Models2[pepe] , "_" , input$Floor
         , "_" , input$Building
         , ".rds"
         , sep = "")
    )

   }
   
  models <- resamples(ModelsLAT2.list
)

  bwplot(models, metric="RMSE")



  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```


###  Longitude MAE

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  
  
   ModelsLAT2.list = as.list(vector(length = length(Models2)))
   
   for (pepe in 1:length(Models2))
   {
    # pepe <- 1
  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 ModelsLAT2.list[[pepe]] <-  readRDS( 
  paste ("./models/Long_" , Models2[pepe] , "_" , input$Floor
         , "_" , input$Building
         , ".rds"
         , sep = "")
    )

   }
   
  models <- resamples(ModelsLAT2.list
)


 bwplot(models, metric="MAE")


  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```




Building and Floor Prediction
=======================================================================


Column {.sidebar data-width=150}
-----------------------------------------------------------------------

```{r}

  
#selectInput("Submet", label = "Submet:",
#            choices = c("AC" ,"Rest","Laundry","Kitchen"), selected = "AC")

selectInput("Building1", label = "Building :",
            choices = c("B0","B1","B2"), selected = "B0")


# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

# sliderInput("bw_adjust", label = "Bandwidth adjustment:",
#             min = 0.2, max = 2, value = 1, step = 0.2)
```

Column {data-width=450}
-----------------------------------------------------------------------


### Building Prediction based on all dataset.

```{r include=TRUE, results='asis'}



  
prueba <- ggplot(data = ValidProbs) +
  aes(x = B0) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)


ggplotly(prueba)

     #}
```


Column {data-width=450}
-----------------------------------------------------------------------

### Floor Prediction F0

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  ValidationFloorSet <- ValidationSet %>% filter(BUILDINGID == input$Building1)

  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 FloorFit <-  readRDS( 
  paste ("./models/FloorXGBoost_" , input$Building1 , ".rds", sep = "")
    )

 # prueba2 <- ggplot(data = ValidationFloorSet) +
 #  aes(x = BUILDINGID) +
 #  geom_density(adjust = 1, fill = "#0c4c8a") +
 #  theme_minimal()
#prueba <- prueba + aes(y = B1)
 
  ValidFloorProbs <- predict(FloorFit, newdata = ValidationFloorSet, type = "prob")

prueba2 <- ggplot(data = ValidFloorProbs) +
  aes(x = F0) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)

prueba2

  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```




### Floor Prediction F1

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  ValidationFloorSet <- ValidationSet %>% filter(BUILDINGID == input$Building1)

  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 FloorFit <-  readRDS( 
  paste ("./models/FloorXGBoost_" , input$Building1 , ".rds", sep = "")
    )

 # prueba2 <- ggplot(data = ValidationFloorSet) +
 #  aes(x = BUILDINGID) +
 #  geom_density(adjust = 1, fill = "#0c4c8a") +
 #  theme_minimal()
#prueba <- prueba + aes(y = B1)
 
  ValidFloorProbs <- predict(FloorFit, newdata = ValidationFloorSet, type = "prob")

prueba2 <- ggplot(data = ValidFloorProbs) +
  aes(x = F1) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)

prueba2

  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```


### Floor Prediction F2

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  ValidationFloorSet <- ValidationSet %>% filter(BUILDINGID == input$Building1)

  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 FloorFit <-  readRDS( 
  paste ("./models/FloorXGBoost_" , input$Building1 , ".rds", sep = "")
    )

 # prueba2 <- ggplot(data = ValidationFloorSet) +
 #  aes(x = BUILDINGID) +
 #  geom_density(adjust = 1, fill = "#0c4c8a") +
 #  theme_minimal()
#prueba <- prueba + aes(y = B1)
 
  ValidFloorProbs <- predict(FloorFit, newdata = ValidationFloorSet, type = "prob")

prueba2 <- ggplot(data = ValidFloorProbs) +
  aes(x = F2) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)

prueba2

  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```




### Floor Prediction F3

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  ValidationFloorSet <- ValidationSet %>% filter(BUILDINGID == input$Building1)

  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 FloorFit <-  readRDS( 
  paste ("./models/FloorXGBoost_" , input$Building1 , ".rds", sep = "")
    )

 # prueba2 <- ggplot(data = ValidationFloorSet) +
 #  aes(x = BUILDINGID) +
 #  geom_density(adjust = 1, fill = "#0c4c8a") +
 #  theme_minimal()
#prueba <- prueba + aes(y = B1)
 
  ValidFloorProbs <- predict(FloorFit, newdata = ValidationFloorSet, type = "prob")

prueba2 <- ggplot(data = ValidFloorProbs) +
  aes(x = F3) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)

prueba2

  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```



### Floor Prediction F4

```{r include=TRUE, results='asis'}
# prueba <- ggplot(data = Test) +
#   aes(x = year, y = SubMet_Energy) +
#   geom_point(color = "#0c4c8a") +
#   theme_minimal()
# 
# ggplotly(prueba)
# SeasonDF = data.frame(list(Name=c("Autunm","Winter", "Spring","Summer"), 
#               Result=c(1,2,3,4)))

 setwd("d:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")

     
renderPlot({
    
  # padding <- as.numeric(ValidationSet %>% filter(BUILDINGID == input$Building) %>%
  #   select (Result) )
  ValidationFloorSet <- ValidationSet %>% filter(BUILDINGID == input$Building1)

  setwd("D:/dropbox/Dropbox/ubiqum/8. Wifi Locating/8-Wifi-Locating")
 FloorFit <-  readRDS( 
  paste ("./models/FloorXGBoost_" , input$Building1 , ".rds", sep = "")
    )

 # prueba2 <- ggplot(data = ValidationFloorSet) +
 #  aes(x = BUILDINGID) +
 #  geom_density(adjust = 1, fill = "#0c4c8a") +
 #  theme_minimal()
#prueba <- prueba + aes(y = B1)
 
  ValidFloorProbs <- predict(FloorFit, newdata = ValidationFloorSet, type = "prob")

prueba2 <- ggplot(data = ValidFloorProbs) +
  aes(x = F4) +
  geom_density(adjust = 1, fill = "#0c4c8a") +
  theme_minimal()
#prueba <- prueba + aes(y = B1)

prueba2

  #ACplot <- autoplot(ValidFloorProbs)
  
  
  # ACplot <- ACplot + ggtitle("Energy in AC&Heating x Hour for 1 Day")
  #   ACplot <- ACplot + xlim(c(2010.50+(padding[1]*0.25), 2010.75+(padding[1]*0.25)))
  # ACplot <- ACplot  + xlab(input$Season) #+ scale_x_discrete(name =input$Season, limits=c(2010.75, 2011))
  # ACplot <- ACplot + ylab("Energy Consumption Wh")

  #ACplot
  
})


```





